# Mini-Analytics

## –ü—Ä–µ–¥—É—Å–ª–æ–≤–∏—è

| –ü–û          | –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è                          |
| ----------- | ------------------------------------------- |
| **Node.js** | 18.18.0 (—Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ 20 LTS)              |
| **pnpm**    | 9.0.0                                       |
| **MongoDB** | 6.x (–ª–æ–∫–∞–ª—å–Ω–æ –∏–ª–∏ –æ—Ç–¥–∞–ª—ë–Ω–Ω—ã–π Atlas –∫–ª–∞—Å—Ç–µ—Ä) |

> –í–µ—Ä—Å–∏–∏ —Ñ–∏–∫—Å–∏—Ä—É—é—Ç—Å—è –≤ `package.json` —á–µ—Ä–µ–∑ –ø–æ–ª–µ `engines`, –ø–æ—ç—Ç–æ–º—É –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ/—É—Å—Ç–∞–Ω–æ–≤–∫–µ –Ω–µ—Å–æ–≤–º–µ—Å—Ç–∏–º—ã—Ö –≤–µ—Ä—Å–∏–π –≤—ã —Å—Ä–∞–∑—É –ø–æ–ª—É—á–∏—Ç–µ –ø–æ–Ω—è—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç `pnpm`.

## –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –∑–∞–ø—É—Å–∫

```bash
# —Ç–µ—Ä–º–∏–Ω–∞–ª 1
cp .env.example .env # —Å–æ–∑–¥–∞–µ–º env –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (–ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –∏–∑–º–µ–Ω–∏—Ç—å –ø–æ—Ä—Ç—ã)

pnpm mongo:reset # —á–∏—Å—Ç–∏–º –≤—Å–µ –∏–Ω—Å—Ç–∞–Ω—Å—ã mongo, –∑–∞–ø—É—Å–∫–∞–µ–º—Å—è –∑–∞–Ω–æ–≤–æ

pnpm run dev # –∑–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ

# —Ç–µ—Ä–º–∏–Ω–∞–ª 2
npx wscat -c ws://localhost:8080 # –∑–∞–ø—É—Å–∫–∞–µ–º —Å–ª—É—à–∞—Ç–µ–ª—å WebSocket

# –†–µ–∫–æ–º–º–µ–Ω–¥—É–µ—Ç—Å—è —Ç–µ—Ä–º–∏–Ω–∞–ª 3 –¥–ª—è HTTP, —Ä—É—á–Ω–æ–≤–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å Mongo
```

## –°—Ä–∞–∑—É –ø–æ—è—Å–Ω–µ–Ω–∏–µ –ø—Ä–æ rs0 —Ñ–ª–∞–≥

**–ü–æ—á–µ–º—É `replicaSet=rs0` –∏ —Ñ–ª–∞–≥ `--replSet rs0`?**

Change Streams —Ä–∞–±–æ—Ç–∞—é—Ç **—Ç–æ–ª—å–∫–æ** –≤ —Ä–µ–ø–ª–∏–∫–∞-–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ MongoDB.
–î–∞–∂–µ –æ–¥–∏–Ω–æ—á–Ω—ã–π (stand-alone) –∏–Ω—Å—Ç–∞–Ω—Å –Ω—É–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–∫ —Ä–µ–ø–ª–∏–∫—É.  
–ü–æ—ç—Ç–æ–º—É —Å–∫—Ä–∏–ø—Ç `mongo:reset` –ø–æ–¥–Ω–∏–º–∞–µ—Ç Mongo —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º `--replSet rs0`,
–∞ –≤ `MONGO_URI` –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è `/?replicaSet=rs0`.

## –¢–µ—Å—Ç —Å–µ—Ä–≤–µ—Ä–æ–≤

### –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è:

```h
curl -X POST http://localhost:3000/messages \
  -H 'Content-Type: application/json' \
  -d '{"text":"hello"}'

# => {"ok":true}
```

### –ß—Ç–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π:

```h
curl http://localhost:3000/messages | jq

# —É–≤–∏–¥–∏—Ç–µ –º–∞—Å—Å–∏–≤ —Å –æ–¥–Ω–∏–º –¥–æ–∫—É–º–µ–Ω—Ç–æ–º
```

### WebSockets

```h
npx wscat -c ws://localhost:8080

# –ü–æ—Å–ª–µ POST —Å—Ç—Ä–æ–∫–æ–π –≤—ã—à–µ –ø—Ä–∏–¥—ë—Ç JSON —Å–æ–æ–±—â–µ–Ω–∏—è
```

### –ö–∞–∫ –ø–æ–Ω—è—Ç—å —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –Ω–∏—á–µ–≥–æ –Ω–µ —Ç–µ—Ä—è–µ—Ç

```ts
// –ü–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–µ—Ä–≤–µ—Ä –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ 1

// –í—Ä—É—á–Ω—É—é –¥–æ–±–∞–≤–∏—Ç—å –≤ "—Ç–µ—Ä–º–∏–Ω–∞–ª–µ 3" 2 –¥–æ–∫—É–º–µ–Ω—Ç–∞ –≤ –î–ë

mongosh --eval '
db = db.getSiblingDB("messagesApp");
db.messages.insertMany([
  { text: "while server down 1", createdAt: new Date() },
  { text: "while server down 2", createdAt: new Date() }
]);
'

// –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–µ—Ä —Å–Ω–æ–≤–∞ `pnpm dev`

// –£–≤–∏–¥–µ—Ç—å 2 –ª–æ–≥–∞
// üíæ CHANGE while server down 1
// üíæ CHANGE while server down 2
```

## –ò—Ç–æ–≥:

- –°–µ—Ä–≤–µ—Ä **–Ω–µ —Ç–µ—Ä—è–µ—Ç** —Å–æ–±—ã—Ç–∏—è Mongo –º–µ–∂–¥—É —Ä–µ—Å—Ç–∞—Ä—Ç–∞–º–∏ ‚Äì- —ç—Ç–æ –º—ã —É–±–µ–¥–∏–ª–∏—Å—å –ø–æ –ª–æ–≥–∞–º.
- WebSocket-–∫–ª–∏–µ–Ω—Ç, –ø–æ–¥–∫–ª—é—á–∏–≤—à–∏–π—Å—è –ø–æ–∑–∂–µ, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø–æ–ª—É—á–∞–µ—Ç **—Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ** –∏–∑–º–µ–Ω–µ–Ω–∏—è ‚Äì- —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ —Å–æ–≥–ª–∞—Å–Ω–æ –¢–ó.
