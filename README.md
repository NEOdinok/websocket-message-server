# Mini-Analytics

## Предусловия

| ПО          | Минимальная версия                          |
| ----------- | ------------------------------------------- |
| **Node.js** | 18.18.0 (рекомендовано 20 LTS)              |
| **pnpm**    | 9.0.0                                       |
| **MongoDB** | 6.x (локально или отдалённый Atlas кластер) |

> Версии фиксируются в `package.json` через поле `engines`, поэтому при запуске/установке несовместимых версий вы сразу получите понятное сообщение от `pnpm`.

## Установка и запуск

```bash
# 1 — клонируем репозиторий
$ git clone <repo> && cd fullstack-analytics

# 2 — создаём файлы переменных окружения
$ cp tracker-backend/.env.example tracker-backend/.env
$ cp tracker-client/.env.example  tracker-client/.env
# при необходимости редактируем значения (всё работает «из коробки»)

# 3 — ставим зависимости workspaces
$ pnpm install

# 4 — собираем клиентский bundle (tracker.js)
$ pnpm build:client

# 5 — запускаем бекенд + статические страницы (hot‑reload)
$ pnpm dev:backend
```

После запуска будут доступны

| URL                                | Назначение                            |
| ---------------------------------- | ------------------------------------- |
| `http://localhost:50000/1.html`    | Демо-страница с подключённым трекером |
| `http://localhost:8888/tracker.js` | Скомпилированный скрипт трекера       |
| `http://localhost:8888/track`      | REST-эндпоинт для приёма событий      |

## Переменные окружения

### Backend — `tracker-backend/.env.example`

| Переменная    | Значение по умолчанию       | Назначение                          |
| ------------- | --------------------------- | ----------------------------------- |
| `PORT_STATIC` | `50000`                     | порт демо-страниц                   |
| `PORT_API`    | `8888`                      | порт API / `tracker.js`             |
| `APP_URL`     | `http://localhost`          | хост/протокол, приходящий на клиент |
| `MONGO_URI`   | `mongodb://localhost:27017` | строка подключения к MongoDB        |
| `DB_NAME`     | `analytics`                 | имя базы данных                     |

---

## Client — `tracker-client/.env.example`

| Переменная         | Значение по умолчанию | Назначение                |
| ------------------ | --------------------- | ------------------------- |
| `VITE_PORT_STATIC` | `50000`               | зеркалирует `PORT_STATIC` |
| `VITE_PORT_API`    | `8888`                | зеркалирует `PORT_API`    |
| `VITE_APP_URL`     | `http://localhost`    | зеркалирует `APP_URL`     |

> Эти ключи читаются сборщиком Vite и «зашиваются» непосредственно в bundle.

## P.S

### Затраченное время

Пару вечеров на разработку
Вечер на правку по ревью, доработки

### Что было сложным

- Тайминг буфера – аккуратно совместить правила «не чаще раза в секунду» и «если ≥ 3 событий».

- **Graceful shutdown** – beforeunload не гарантирует, что обычный fetch завершится, поэтому пришлось добавить `sendBeacon` и `keepalive`.

### Почему Fastify?

- Меньше кода и зависимостей, чем Express.
- Плагин `@fastify/mongodb` убирает ручную возню с коннектом.

### Как расширять дальше

1. **Агрегации**: делаете cron-джобу, которая каждую минуту сворачивает `tracks` → коллекцию `daily_stats`.
2. **Админ-панель**: React + Recharts, собственный API `/stats`.
3. **Анонимные пользователи**: добавляете в трекер генерацию `visitorId` (UUID в `localStorage`) и передаёте его вместе с каждым событием.

### Поменял <script> в html файлах

Можно было бы оставить без `.js` на конце

```html
<script src="http://localhost:8888/tracker"></script>
```

Но тогда вместо fastify плагина пришлось бы использовать отдельный роут:

```js
api.get("/tracker", (_, reply) => {
  reply.type("application/javascript").sendFile("tracker.js");
});
```

---
